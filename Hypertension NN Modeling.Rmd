---
title: "Nueral Network Modeling"
author: "Colin Brant"
---
```{r}
#Loads in 205 variables with at least 10,000 data entries
load('/Users/colinbrant/Downloads/capstone-main/selected_Winsorized_df.Rdata')
load('/Users/colinbrant/Downloads/capstone-main/NHANES_Clean.RData')
df <- select
df$CBD121[df$CBD121 == 777777] <- NA
df$WHD110[df$WHD110 == 9999 | df$WHD110 == 7777] <- NA
head(df)
```

```{r}
#All quantative variables available in the select dataset
quant <- c("LBDHDD", "LBDHDDSI", "LBXTR","LBDTRSI" , "LBDLDL"  , "LBDLDLSI", "LBXTC"   , "LBDTCSI" , "LBXGLU"  , "LBDGLUSI" ,"CBD121"  , "CBD131"  ,"DBD900"  , "DBD905"  , "DBD910"  , "PAQ625"  , "PAD630"  , "PAQ670"  , "PAD675"  , "PAD680"  , "WHD010"  , "WHD020"  , "WHD050"  , "WHD110", "WHD120" ,  "WHD130"   ,"WHD140" ,  "WHQ150" ,  "BMXWT"  ,  "BMXHT"  ,  "BMXBMI" ,  "BMXLEG" ,  "BMXARML"  ,"BMXARMC",  "BMXWAIST", "BPD035"  ,"INDFMPIR", "WTINT2YR", "WTMEC2YR")
quant_df <- select[, quant]
quant_df$Hypertension <- select$BPQ020
head(quant_df)
```

Change coding of Hypertension Response
```{r}
quant_df$Hypertension <- as.integer(quant_df$Hypertension)
quant_df$Hypertension[quant_df$Hypertension == 1] <- 1
quant_df$Hypertension[quant_df$Hypertension == 2] <- 0
quant_df$Hypertension <- as.factor(quant_df$Hypertension)
```

To include gender (RIAGENDR) and age in years (RIDAGEYR)
```{r}
quant_df$Age <- select$RIDAGEYR
quant_df$Gender <- select$RIAGENDR
Hypertension <- quant_df$Hypertension
vars <- c('LBDTCSI','CBD121','DBD910','PAD680','WHD020','WHD110','WHD130','BMXHT','BMXBMI', 'BMXLEG', 'BMXARML', 'BMXARMC','BMXWAIST','Age','Gender', 'Hypertension')
```

Use mice for imputation 
Drop all rows where Hypertension is missing so we don't impute responses
```{r}
library(mice)
mice_feed <- quant_df[vars]
mice_feed <- mice_feed[!is.na(mice_feed$Hypertension),]
split <- sample(1:nrow(mice_feed), round(nrow(mice_feed) * 0.7))
train_mice <- mice_feed[split,]
test_mice <- mice_feed[-split,]
mice_data2 <- mice(train_mice, m=3, seed = 123)
```

```{r}
library(ROCR) 
library(Metrics)
test_data <- mice(test_mice, m=3, seed = 123)
```
Change environemnt in order to use keras
```{r}
library(reticulate)
use_condaenv("keras-tf")
```
Istalls tensorflow in the keras-tf environment 
```{r}
library(keras)
library(tensorflow)
install_tensorflow(envname='keras-tf')
```


Create 3 training and testing sets from mice data 
```{r}
mice_train1 <- complete(mice_data2,1)
mice_test1 <- complete(test_data,1)
mice_train_x <- subset(mice_train1,select = -c(Hypertension))
mice_train_y <- mice_train1$Hypertension
mice_test_x <- subset(mice_test1,select = -c(Hypertension))
mice_test_y <- mice_test1$Hypertension

```
Turn Gender into a numeric variable to allow neural net to run
```{r}
mice_train_x$Gender <- as.numeric(mice_train_x$Gender) - 1
mice_test_x$Gender <- as.numeric(mice_test_x$Gender) - 1
class(mice_train_x$Gender)
```
Turn Hypertension into a numeric variable to allow neural net to run
```{r}
mice_train_y <- as.numeric(mice_train_y) - 1
mice_test_y <- as.numeric(mice_test_y) - 1
```

Turn x variables from data frame to a numeric matrix 
```{r}
#mice_train_x <- array_reshape(mice_train_x, c(nrow(mice_train_x), 15))
#mice_test_x <- array_reshape(mice_test_x, c(nrow(mice_test_x), 15))
mice_train_x <- as.matrix(mice_train_x)
mice_test_x <- as.matrix(mice_test_x)
head(mice_train_x)
```
```{r}
class(mice_train_y)
```
```{r}
mice_train_y
```

Make the actual keras model with 5 layers
```{r}
model <- keras_model_sequential() 
model %>% 
  
  layer_dense(units = 128, activation = 'relu', input_shape=c(15)) %>% 
  #layer_dropout(rate = 0.4) %>% 
  layer_dense(units = 64, activation = 'relu') %>%
  layer_dense(units = 32, activation = 'relu') %>%
  layer_dense(units = 16, activation = 'relu') %>%
  #layer_dropout(rate = 0.3) %>%
  layer_dense(units = 1, activation = 'sigmoid')
```
Compile with binary crossentropy as the loss function with accuracy as the metric 
```{r}
model %>% compile(
  loss = 'binary_crossentropy',
  optimizer = optimizer_rmsprop(learning_rate = 0.001),
  metrics = c('accuracy')
)
```
Run the model and plot the results 
```{r}
history <- model %>% keras::fit(
  mice_train_x, mice_train_y, 
  epochs = 20, batch_size = 128, 
  validation_split = 0.2
)
plot(history)
```

